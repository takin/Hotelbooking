<script type="text/javascript" src="<?php echo base_url();?>js/calcprice.js"></script>
<script type="text/javascript">
		
    $("#booking-table form").submit(function() {
			var noerror = false;
			$("#formerror").hide();
      $("#booking-table select").each(function () {
				if ($(this).val() != 0){
					noerror = true;
				}
			});
			
			if (noerror == true){
				noerror = true;
				return true;
			}else{
				$("#formerror").show();
				return false;
			}
			
    });
		
</script>
<h2 class="dotted-line margbot15"><?php echo _('Disponibilités'); ?> <span>(<?php echo $currency; ?>)</span></h2>
<?php

$date = clone $dateStart;
  
  $nbRoomType = 0;
  $sharedRoomsTable = "";
	$sharedRoomsTableSelect = "";
  //Show shared rooms first
  foreach ($booking_rooms as $hostel_room)
  {
    $availableBeds = $hostel_room["BEDS"];
    //Check for dorms only
    if($hostel_room["BLOCKBEDS"]==0)
    {
      
      $date->modify("-$numNights day");
      $nbRoomType++;
      if($nbRoomType % 2 != 0)
      {
        $sharedRoomsTable.= "<tr>";
				$sharedRoomsTableSelect.= "<tr class=\"roomnb\" id=\"sroomnb_".$nbRoomType."\">";
      }
      else
      {
        $sharedRoomsTable.= "<tr class=\"odd\">";
				$sharedRoomsTableSelect.= "<tr id=\"sroomnb_".$nbRoomType."\" class=\"roomnb\">";
      }
      
      $sharedRoomsTable.= '<td class="first">';
			$sharedRoomsTableSelect.= '<td class="first">';
      if(!empty($hostel_room['NAME_TRANSLATED']))
      {
        $sharedRoomsTable.= '<span class="tooltip" title="'._("VERSION ORIGINALE :").' '.$hostel_room['NAME'].'">'.$hostel_room['NAME_TRANSLATED'].'</span>';	
				$sharedRoomsTableSelect.= '<span class="tooltip" title="'._("VERSION ORIGINALE :").' '.$hostel_room['NAME'].'">'.$hostel_room['NAME_TRANSLATED'].'</span>';	
				
      }
      else
      {
        $sharedRoomsTable.= $hostel_room['NAME'];
				$sharedRoomsTableSelect.= $hostel_room['NAME'];
      }

      $sharedRoomsTable.= "</td>";
			$sharedRoomsTableSelect.= "</td>";			
      $date = clone $dateStart;
			$subtotal = 0;
      //Ensure array of nights is sorted by soonest date first
      if(isset($hostel_room['NIGHTS']))
      {
        ksort($hostel_room['NIGHTS']);
        foreach($hostel_room['NIGHTS'] as $dateint => $room_night)
        {
          
          $date_msg = "";
					$display_currency = currency_symbol($room_night["CUSTOMER"]["CURRENCY"]);
          $subtotal = $subtotal+$room_night["CUSTOMER"]["MINPRICE"];
          
					if ($numNights < 8){
						$date_msg.= number_format(round((float)$room_night["CUSTOMER"]["MINPRICE"],2),2);
						$date_msg.= " ".currency_symbol($room_night["CUSTOMER"]["CURRENCY"]);
					}else{
						$date_msg.= number_format(round((float)$room_night["CUSTOMER"]["MINPRICE"],2),0);
					}
					
					$sharedRoomsTable.= '<td align="center">'.$date_msg.'</td>';
          $date->modify("+1 day");
        }
      }
      else
      {
        for($i=0;$i<$numNights;$i++)
        {
          
          $date_msg = "";          
          $subtotal = $subtotal+$hostel_room['PRICES']["CUSTOMER"]["MINPRICE"];          
          $display_currency = currency_symbol($hostel_room['PRICES']["CUSTOMER"]["CURRENCY"]);          
					
					if ($numNights < 8){
						$date_msg.= number_format(round((float)$hostel_room['PRICES']["CUSTOMER"]["MINPRICE"],2),2);
						$date_msg.= " ".currency_symbol($hostel_room['PRICES']["CUSTOMER"]["CURRENCY"]);
					}else{
						$date_msg.= number_format(round((float)$hostel_room['PRICES']["CUSTOMER"]["MINPRICE"],2),0);
					}
					$sharedRoomsTable.= '<td align="center">'.$date_msg.'</td>';
					$date->modify("+1 day");
        }
      }
      
      $sharedRoomsTableSelect.= '<td id="snbguest_'.$nbRoomType.'" class="snbguest">'._('Personnes').': <strong></strong></td>';
	  	$sharedRoomsTableSelect.= '<td align="center" id="ssubtotal_'.$nbRoomType.'" class="ssubtotal"><span class="calc_init" id="ssubtotal_init_'.$nbRoomType.'">'.number_format($subtotal,2,'.','').'</span>'.$display_currency.'  <span class="calc_sum" id="ssubtotal_calc_'.$nbRoomType.'"></span></td>';
      //TODO javascript to prevent more than available beds booking by adding select box value
      
      $sharedRoomsTable.= "<td>";
      $sharedRoomsTable.= "<input type=\"hidden\" name=\"book-roomPreferences[]\" value=\"".$hostel_room['ID']."\" />";
      $sharedRoomsTable.= "<select id=\"sharedsel_".$nbRoomType."\" class=\"sharedsel\" name=\"book-nbPersons[]\">";
      
      $sharedRoomsTable.= "<option value=\"0\" >-</option>\n";
      for($p=1;$p<=$availableBeds;$p++)
      {
        $sharedRoomsTable.= "<option value=\"$p\" >$p</option>\n";
      }
      $sharedRoomsTable.= "</select>";
      $sharedRoomsTable.= "</td>";
      
      $sharedRoomsTable.= "</tr>\n";
			$sharedRoomsTableSelect.= "</tr>\n";
    }

  }
	$colspan = $numNights+2;
	
	//Count shared room that are displayed
	$sharedRoomCount = $nbRoomType;
	
  //Show private rooms
  $nbRoomType = 0;
  $privateRoomsTable = "";
	$privateRoomsTableSelect = "";
  
  foreach ($booking_rooms as $hostel_room)
  {
    $availableBeds  = $hostel_room["BEDS"];
    
    //Check for dorms only
    if($hostel_room["BLOCKBEDS"] > 0)
    {
      $availableRooms = $hostel_room["BEDS"] / $hostel_room["BLOCKBEDS"];
      
      $date->modify("-$numNights day");
      $nbRoomType++;
      if($nbRoomType % 2 != 0)
      {
        $privateRoomsTable.=  "<tr>";
				$privateRoomsTableSelect.= "<tr class=\"roomnb\" id=\"proomnb_".$nbRoomType."\">";
      }
      else
      {
        $privateRoomsTable.= "<tr class=\"odd\">";
				$privateRoomsTableSelect.= "<tr id=\"proomnb_".$nbRoomType."\" class=\"roomnb\">";
      }
      
      $privateRoomsTable.= '<td class="first">';
			$privateRoomsTableSelect.= '<td class="first">';
      if(!empty($hostel_room['NAME_TRANSLATED']))
      {
        $privateRoomsTable.= '<span class="tooltip" title="'._("VERSION ORIGINALE :").' '.$hostel_room['NAME'].'">'.$hostel_room['NAME_TRANSLATED'].'</span>';	
				$privateRoomsTableSelect.= '<span class="tooltip" title="'._("VERSION ORIGINALE :").' '.$hostel_room['NAME'].'">'.$hostel_room['NAME_TRANSLATED'].'</span>';	
				
      }
      else
      {
        $privateRoomsTable.= $hostel_room['NAME'];
				$privateRoomsTableSelect.= $hostel_room['NAME'];
      }

      $privateRoomsTable.= "</td>";
			$privateRoomsTableSelect.= "</td>";
      $date = clone $dateStart;
      $subtotal = 0;
    //Ensure array of nights is sorted by soonest date first
      if(isset($hostel_room['NIGHTS']))
      {
        ksort($hostel_room['NIGHTS']);
        foreach($hostel_room['NIGHTS'] as $dateint => $room_night)
        {
//          $tt = new Datetime($dateint);
//          echo $tt->format("Y-m-d") . " - ";
//          echo $dateint. " VS ".time() ." - ". date("d-M-Y",mktime(0,0,0,1,0+$dateint,1900)). "<br>";
					$display_currency = currency_symbol($room_night["CUSTOMER"]["CURRENCY"]);
					$subtotal = $subtotal+$room_night["CUSTOMER"]["MINPRICE"]*$hostel_room["BLOCKBEDS"];  
					$date_msg = "";
					
          if ($numNights < 8){
						$date_msg.= number_format(round((float)$room_night["CUSTOMER"]["MINPRICE"]*$hostel_room["BLOCKBEDS"],2),2);
						$date_msg.= " ".currency_symbol($room_night["CUSTOMER"]["CURRENCY"]);	
						
					}else{
						
						$date_msg.= number_format(round((float)$room_night["CUSTOMER"]["MINPRICE"]*$hostel_room["BLOCKBEDS"],2),0);
					}
					
					$privateRoomsTable.= '<td align="center">'.$date_msg.'</td>';
					$date->modify("+1 day");
        }
      }
      else
      {
        for($i=0;$i<$numNights;$i++)
        {
          
          $date_msg = "";
          $subtotal = $subtotal+$hostel_room['PRICES']["CUSTOMER"]["MINPRICE"]*$hostel_room["BLOCKBEDS"];  
          $display_currency = currency_symbol($hostel_room['PRICES']["CUSTOMER"]["CURRENCY"]);
					
					if ($numNights < 8){
						$date_msg.= number_format(round((float)$hostel_room['PRICES']["CUSTOMER"]["MINPRICE"]*$hostel_room["BLOCKBEDS"],2),2);
						$date_msg.= " ".currency_symbol($hostel_room['PRICES']["CUSTOMER"]["CURRENCY"]);
					}else{
						
						$date_msg.= number_format(round((float)$hostel_room['PRICES']["CUSTOMER"]["MINPRICE"]*$hostel_room["BLOCKBEDS"],2),0);
					}
					
					$privateRoomsTable.= '<td align="center">'.$date_msg.'</td>';
          $date->modify("+1 day");
        }
      }
      
      $privateRoomsTableSelect.= '<td id="pnbguest_'.$nbRoomType.'" class="pnbguest">'._('Rooms').': <strong></strong></td>';
			$privateRoomsTableSelect.= '<td align="center" id="psubtotal_'.$nbRoomType.'" class="psubtotal"><span class="calc_init" id="psubtotal_init_'.$nbRoomType.'">'.number_format($subtotal,2,'.','').'</span>'.$display_currency.'  <span class="calc_sum" id="psubtotal_calc_'.$nbRoomType.'"></span></td>';
			
      //TODO javascript to prevent more than available rooms booking by adding select box value
      
      $privateRoomsTable.= "<td>";
      $privateRoomsTable.= "<input type=\"hidden\" name=\"book-roomPreferences[]\" value=\"".$hostel_room['ID']."\" />";
      $privateRoomsTable.= "<select id=\"privatesel_".$nbRoomType."\" class=\"privatesel\" name=\"book-nbPersons[]\">";
      
      $privateRoomsTable.= "<option value=\"0\" >-</option>\n";
      for($p=1;$p<=$availableRooms;$p++)
      {
          $privateRoomsTable.= "<option value=\"".$p*$hostel_room["BLOCKBEDS"]."\" >$p</option>\n";
      }
      $privateRoomsTable.= "</select>";
//      $privateRoomsTable.= "N/A";
      $privateRoomsTable.= "</td>";
      
      $privateRoomsTable.= "</tr>\n";
			$privateRoomsTableSelect.= "</tr>\n";
    }

  }
	
	$colspan = $numNights+2;
  $privateRoomCount = $nbRoomType;
  
  
  if( ($sharedRoomCount === 0) && ($privateRoomCount === 0 ))
  {
    $errortext  = "No Beds Found";
    $detailtext = "No Beds could be found for your search criteria. Please change your dates and try again.";
    
    //Google translate the error text and detail
    $this->load->model('google/Gtranslateapi');
    $this->Gtranslateapi->StartBatch($this->site_lang,"en");
    $this->Gtranslateapi->addTextForBatch($errortext);
    $this->Gtranslateapi->addTextForBatch($detailtext);
    $gtrans = $this->Gtranslateapi->end_batch();
    
//    if($_SERVER['REMOTE_ADDR'] == "206.126.80.242")
//    {
//      debug_dump($gtrans);
//    }
    if($gtrans["responseData"][0]["responseStatus"] == 200)
    {
      if(!empty($gtrans["responseData"][0]["responseData"]["translatedText"]) )
      {
        $errortext = $gtrans["responseData"][0]["responseData"]["translatedText"];
      } 
    }
    
    if($gtrans["responseData"][1]["responseStatus"] == 200)
    {
      if(!empty($gtrans["responseData"][1]["responseData"]["translatedText"]) )
      {
        $detailtext = $gtrans["responseData"][1]["responseData"]["translatedText"];
      } 
    }
    ?>
    <div class="dispo-error">
    <p>
      <strong><?php echo _("Erreur:");?> </strong> 
      <?php 
      echo $errortext;
      ?>
    </p>
    <p>
      <strong><?php echo _("Détails:");?> </strong>
      <?php 
      echo $detailtext;
      ?>
    </p>
    </div>
    <?php
  }
  else
  {
    ?>
    <form class="clearfix" method="post" action="<?php echo secure_site_url($this->Db_links->get_link("booking")); ?>">
    
    <table border="0" cellpadding="0" cellspacing="0">
    <tbody>
    <?php
    if ($sharedRoomCount > 0)
  	{
  	  ?>
  		<tr>
        <th class="title"><?php echo _('Chambres partagées - Dortoirs'); ?></th>
      
        <?php 
        $date = clone $dateStart;
        
        for($i=0;$i<$numNights;$i++)
        {
          echo "<th>";
          echo  my_mb_ucfirst(mb_substr(strftime("%a",$date->format('U')),0,2));
          echo strftime("<br />%e",$date->format('U'));
          $date->modify("+1 day");
          echo "</th>";
        }
        ?>
        <th class="last"><?php echo _('Personnes'); ?></th>
      </tr>
    
    <?php
      echo $sharedRoomsTable;
  	}
    
    if ($privateRoomCount > 0)
  	{
  	  ?>
      <tr>
        <th class="title">
          <?php echo _('Chambres privées'); ?></th>
      
        <?php 
        $date = clone $dateStart;
        
        for($i=0;$i<$numNights;$i++)
        {
          echo "<th>";
          echo my_mb_ucfirst(mb_substr(strftime("%a",$date->format('U')),0,2));
        echo strftime("<br />%e",$date->format('U'));
          $date->modify("+1 day");
          echo "</th>";
        }
        ?>
        <th class="last"><?php echo _('Rooms'); ?></th>
      </tr>
      <?php
       
  		echo $privateRoomsTable;
  	}
    ?>
    </tbody>
    </table>
		
		<table id="selection" border="0" cellpadding="0" cellspacing="0">
			<tbody>
			<tr>
					<th colspan="3" class="title"><?php echo _('Your Selection'); ?></th>
			</tr>
			<?php
			if ($sharedRoomCount > 0)
			{
				echo $sharedRoomsTableSelect;
			}
			
			if ($privateRoomCount > 0)
			{
				echo $privateRoomsTableSelect;
			}
			?>
			<tr>
					<td class="first" align="right" colspan="2"><strong><?php echo _('Total'); ?></strong></td>
					<td align="center"><?php echo $display_currency;?> <strong id="bigTotal">0.00</strong></td>
			</tr>
			<tr>
					<td class="first" align="right" colspan="2"><strong><?php echo _('10% Arrhes / Dépôt sera facturé en');?></strong></td>
					<td align="center"><?php echo $display_currency;?> <strong id="depositTotal">0.00</strong></td>
			</tr>
			</tbody>
    </table>
    <input type="hidden" name="book-propertyName" value="<?php echo $propertyName; ?>" />
    <input type="hidden" name="book-propertyNumber" value="<?php echo $propertyNumber; ?>" />
    <input type="hidden" name="book-dateStart" value="<?php echo $dateStart->format('Y-m-d'); ?>" />
    <input type="hidden" name="book-numNights" value="<?php echo $numNights; ?>" />
    <input type="hidden" name="book-currency" value="<?php echo $currency; ?>" />
    <input type="hidden" name="book-property-cards" value="<?php echo $property_cards; ?>" />
    <div class="bottom-table clearfix">
      <img class="ccard" src="<?php echo site_url();?>images/ccard.gif" alt="<?php echo _("carte de crédit");?>" />
      
      <input type="submit" onfocus="this.blur()" name="booking-form" id="booking-form-submit" value="<?php echo _("Réserver Maintenant"); ?>" />
      <img src="<?php echo site_url();?>images/padlock.png" alt="<?php echo _("sécurisé");?>" />
      <span style=""><?php echo _("Payer seulement 10% maintenant")?> </span>
    </div>
    
    </form>
		<p class="red-error" id="formerror"><?php echo _('Please enter at least one choice in the above table to book a room.');?></p>
    <?php
  }
  ?>
<script type="text/javascript" src="<?php echo base_url();?>js/tooltip.js"></script>